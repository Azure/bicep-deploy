"use strict";var S=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var O=(e,n)=>{for(var o in n)S(e,o,{get:n[o],enumerable:!0})},q=(e,n,o,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of L(n))!j.call(e,r)&&r!==o&&S(e,r,{get:()=>n[r],enumerable:!(t=$(n,r))||t.enumerable});return e};var K=e=>q(S({},"__esModule",{value:!0}),e);var Ce={};O(Ce,{formatJson:()=>J,formatWhatIfOperationResult:()=>Q});module.exports=K(Ce);var G={"\x1B[0m":"Reset","\x1B[31m":"Red","\x1B[32m":"Green","\x1B[33m":"Yellow","\x1B[34m":"Blue","\x1B[35m":"Magenta","\x1B[36m":"Cyan","\x1B[37m":"White"};function B(e,n){switch(e){case"off":return"";case"ansii":return n;case"debug":return`<${G[n].toUpperCase()}>`}return n}var l=class{constructor(n){this.colorMode=n;this.colorStack=[];this.buffer=""}append(n,o){return o&&this.pushColor(o),this.buffer+=n,o&&this.popColor(),this}appendLine(n=""){return this.append(n+`
`)}withColorScope(n,o){this.pushColor(n),o(),this.popColor()}pushColor(n){this.colorStack.push(n),this.buffer+=B(this.colorMode,n)}popColor(){this.colorStack.pop();let n=this.colorStack[this.colorStack.length-1]??"\x1B[0m";this.buffer+=B(this.colorMode,n)}build(){return this.buffer}};var W={Create:"\x1B[32m",Delete:"\x1B[31m",Modify:"\x1B[35m",Deploy:"\x1B[34m",NoChange:"\x1B[0m",Ignore:"\x1B[37m",Unsupported:"\x1B[37m"},m={Create:"\x1B[32m",Delete:"\x1B[31m",Modify:"\x1B[35m",Array:"\x1B[35m",NoEffect:"\x1B[37m"},M={Create:"+",Delete:"-",Modify:"~",Deploy:"!",NoChange:"=",Ignore:"*",Unsupported:"x"},z={Create:"+",Delete:"-",Modify:"~",Array:"~",NoEffect:"x"},f={Delete:0,Create:1,Deploy:2,Modify:3,NoChange:4,Unsupported:5,Ignore:6},I={Delete:0,Create:1,Modify:2,Array:2,NoEffect:3},F={Array:"Modify",Create:"Create",Delete:"Delete",Modify:"Modify",NoEffect:"NoChange"};function J(e,n){let o=new l(n);return p(o,e),o.build()}function Q(e,n){let o=new l(n);return Y(o),X(o,e.changes??[]),H(o,e.changes??[]),Z(o,e.changes??[]),o.build()}function Y(e){e.appendLine(`Note: The result may contain false positive predictions (noise).
You can help us improve the accuracy of the result by opening an issue here: https://aka.ms/WhatIfIssues`),e.appendLine()}function X(e,n){if(!n.length)return;let o=new Set;function t(a){if(a.length)for(let i of a){let s=i.propertyChangeType;o.add(F[s]),t(i.children??[])}}for(let a of n)o.add(a.changeType),t(a.delta??[]);let r=Array.from(o).sort((a,i)=>f[a]-f[i]);e.append("Resource and property changes are indicated with "),e.appendLine(r.length===1?"this symbol:":"these symbols:");for(let a of r){let i=M[a],s=W[a];g(e),e.append(i,s).append(" "),e.appendLine(a.charAt(0).toUpperCase()+a.slice(1))}}function Z(e,n){if(e.appendLine().append("Resource changes: "),!n.length){e.append("no change.");return}let o=n.sort((i,s)=>f[i.changeType]-f[s.changeType]),t=P(o,i=>i.changeType),a=d(t).map(([i,s])=>({key:i,count:s.length})).filter(i=>i.count>0).map(i=>_(i.key,i.count));e.append(a.join(", ")).append(".")}function _(e,n){switch(e){case"Create":return`${n} to create`;case"Delete":return`${n} to delete`;case"Deploy":return`${n} to deploy`;case"Modify":return`${n} to modify`;case"Ignore":return`${n} to ignore`;case"NoChange":return`${n} no change`;case"Unsupported":return`${n} unsupported`;default:throw new Error(`Invalid ChangeType: ${e}`)}}function H(e,n){if(!n.length)return;let o=new Set(n.map(C)).size,t=P(n.sort((r,a)=>C(r).localeCompare(C(a))),C);e.appendLine(),e.appendLine(`The deployment will update the following ${o===1?"scope:":"scopes:"}`);for(let[,r]of d(t)){let a=A(r[0]);v(e,a,r)}}function v(e,n,o){e.appendLine().appendLine(`Scope: ${n}`);let t=o.sort((a,i)=>f[a.changeType]-f[i.changeType]),r=P(t,a=>a.changeType);for(let[a,i]of d(r))e.withColorScope(W[a],()=>{for(let s of i){let u=s===t[t.length-1];ee(e,s,u)}})}function ee(e,n,o){let t=n.changeType,r=ge(n),a=fe(n);if(e.appendLine(),ne(e,t,r,a),t==="Create"&&n.after)p(e,n.after,void 0,void 0,2);else if(t==="Delete"&&n.before)p(e,n.before,void 0,void 0,2);else if(n.delta){let i=n.delta;e.withColorScope("\x1B[0m",()=>{e.appendLine(),b(e,R(i))})}else o&&e.appendLine()}function ne(e,n,o,t){k(e,o,0,1,r=>oe(r,n),r=>te(r,t))}function oe(e,n){let o=M[n];e.append(o).append(" ")}function te(e,n){n&&e.withColorScope("\x1B[0m",()=>{e.append(" "),e.append("["),e.append(n),e.append("]")})}function b(e,n,o=2){let t=he(n);for(let r of n)re(e,r,t,o),e.appendLine()}function re(e,n,o,t){let r=n.propertyChangeType,a=n.before,i=n.after,s=n.children||[];switch(r){case"Create":y(e,n,n.after,o,t),x(e,i,t+1);break;case"Delete":y(e,n,n.before,o,t),U(e,a,t+1);break;case"Modify":y(e,n,n.before,o,t),pe(e,a,i,s,t+1);break;case"Array":y(e,n,n.children,o,t),ce(e,n,s,t+1);break;case"NoEffect":y(e,n,n.after,o,t),ie(e,i,t+1);break;default:throw new Error(`Unknown property change type: ${r}.`)}}function y(e,n,o,t,r){if(!n.path)return;let a=n.path,i=n.propertyChangeType,s=t-a.length+1;w(o)?s=1:(c(o)||i==="Modify"&&n.children)&&(s=0),k(e,a,s,r,u=>ae(u,i),E)}function ae(e,n){let o=z[n],t=m[n];e.append(o,t).append(" ")}function ie(e,n,o){e.withColorScope(m.NoEffect,()=>{p(e,n,void 0,void 0,o)})}function x(e,n,o){e.withColorScope(m.Create,()=>{p(e,n,void 0,void 0,o)})}function U(e,n,o){e.withColorScope(m.Delete,()=>{p(e,n,void 0,void 0,o)})}function se(e){if(e===null||typeof e!="object"||Object.keys(e).length===0)return e;let n="",o=e,t=Object.keys(o);for(let r=0;r<t.length;r++){let a=o[r.toString()];if(typeof a!="string"||a.length!==1)return e;n+=a}return n}function pe(e,n,o,t,r){t&&t.length>0?(e.appendLine().appendLine(),b(e,R(t),r)):(U(e,n,r),c(n)?(e.appendLine(),g(e,r)):e.append(" "),e.append("=>"),c(o)||e.append(" "),x(e,o,r),!h(n)&&h(o)&&e.appendLine())}function ce(e,n,o,t){if(n.path||(t-=1,g(e,t)),!o||o.length===0){e.appendLine("[]");return}e.append("[").appendLine(),b(e,R(o),t),g(e,t),e.append("]")}function fe(e){if(e.before)return e.before.apiVersion;if(e.after)return e.after.apiVersion}function A(e){if(!e.resourceId)throw new Error("Extensible resource what-if is not currently supported by this Action. Please raise an issue: https://github.com/Azure/bicep-deploy/issues.");let[n]=N(e.resourceId);return n}function C(e){return A(e).toUpperCase()}function ge(e){if(!e.resourceId)throw new Error("Extensible resource what-if is not currently supported by this Action. Please raise an issue: https://github.com/Azure/bicep-deploy/issues.");let[,n]=N(e.resourceId);return n}function he(e){if(!e||e.length===0)return 0;let o=e.filter(ue).map(t=>t.path.length);return Math.max(...o,0)}function ue(e){let n=e.propertyChangeType;return n==="Create"?h(e.after):n==="Delete"||n==="Modify"?h(e.before):!e.children}function p(e,n,o="",t=0,r=0){if(n=se(n),h(n)){let a=t-o.length+1;T(e,o,a>0?a:0,r),le(e,n)}else if(w(n))T(e,o,1,r),ye(e,n,r);else if(c(n))V(e,n,o,t,r);else throw new Error(`Invalid JSON value: ${n}`)}function le(e,n){n===null?e.append("null"):typeof n=="boolean"?e.append(String(n).toLowerCase()):typeof n=="string"?e.append('"').append(n).append('"'):Array.isArray(n)&&n.length===0?e.append("[]"):typeof n=="object"?e.append("{}"):e.append(String(n))}function ye(e,n,o){e.append("[","\x1B[0m").appendLine();let t=de(n);n.forEach((r,a)=>{let i=String(a);c(r)?(T(e,i,0,o+1),V(e,r,void 0,void 0,o+1)):p(e,r,i,t,o+1),e.appendLine()}),g(e,o),e.append("]","\x1B[0m")}function V(e,n,o="",t=0,r=0){let a=!o;o||(e.appendLine().appendLine(),t=D(n),r+=1);for(let[i,s]of d(n)){let u=a?i:`${o}.${i}`;p(e,s,u,t,r),c(s)||e.appendLine()}}function T(e,n,o,t){k(e,n,o,t,void 0,E)}function k(e,n,o,t,r,a){n&&(g(e,t),r&&r(e),e.append(n),a&&a(e),e.append(" ".repeat(o)))}function E(e){e.append(":","\x1B[0m")}function g(e,n=1){e.append(" ".repeat(2*n))}function de(e){let n=0;return e.forEach((o,t)=>{h(o)&&(n=t)}),String(n).length}function D(e){let n=0;for(let[o,t]of d(e)){if(w(t))continue;let r=c(t)?o.length+1+D(t):o.length;n=Math.max(n,r)}return n}function h(e){return e==null||typeof e=="boolean"||typeof e=="number"||typeof e=="string"||Array.isArray(e)&&e.length===0||typeof e=="object"&&e&&Object.keys(e).length===0}function w(e){return Array.isArray(e)&&e.length>0}function c(e){return typeof e=="object"&&e!==null&&Object.keys(e).length>0}function R(e){return e.slice().sort((n,o)=>I[n.propertyChangeType]-I[o.propertyChangeType]||n.path.localeCompare(o.path))}function P(e,n){return e.reduce((o,t)=>{let r=n(t);return(o[r]=o[r]||[]).push(t),o},{})}function d(e){return Object.entries(e)}function N(e){let n="/providers/",o=e.lastIndexOf(n);if(o===-1){let t=[...e.matchAll(/^(\/subscriptions\/[^/]+)\/(resourceGroups\/[^/]+)$/gi)];return t[0]?[t[0][1],t[0][2]]:["/",e.substring(1)]}return[e.substring(0,o),e.substring(o+n.length)]}0&&(module.exports={formatJson,formatWhatIfOperationResult});
//# sourceMappingURL=whatif.js.map
